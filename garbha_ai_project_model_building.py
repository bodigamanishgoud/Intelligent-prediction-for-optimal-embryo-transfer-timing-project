# -*- coding: utf-8 -*-
"""Garbha.ai Project Model Building

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1IZnRDEP6KRwdadTViInHYnG5xwo2tRQ-
"""

from ultralytics import YOLO;

# 1. Install the necessary library (YOLOv8 framework)
# This will install ultralytics and its dependencies
!pip install ultralytics

# 2. Import necessary modules for file handling and training
import os
import glob
import shlex
from ultralytics import YOLO

# Display installed version
print("YOLOv8 installed successfully.")
!yolo --version

# 1. Define the variables for paths
ZIP_FILE_NAME = "Exclusive GARBHA.ai Project dataset.zip" # <-- UPDATE THIS IF YOUR ZIP HAS A DIFFERENT NAME
UNZIPPED_DIR = "/content/unzipped_data"
DATA_YAML_PATH = "/content/data.yaml"

# 2. Upload the ZIP file and data.yaml
# RUN THIS CELL, THEN CLICK "CHOOSE FILES" AND SELECT BOTH YOUR LARGE ZIP FILE
# AND YOUR data.yaml FILE.
print("--- UPLOAD STEP ---")
print(f"Please upload your main ZIP file (e.g., '{ZIP_FILE_NAME}') AND the 'data.yaml' file now.")
from google.colab import files
uploaded = files.upload()

# 3. Find the uploaded ZIP file name automatically
uploaded_zip_files = [f for f in uploaded.keys() if f.endswith('.zip')]

if not uploaded_zip_files:
    print("\n❌ ERROR: No ZIP file was uploaded. Please try the upload step again.")
else:
    ACTUAL_ZIP_FILE = uploaded_zip_files[0]

    # 4. Create destination folder
    !mkdir -p {UNZIPPED_DIR}

    # 5. Unzip the file safely
    print(f"\n--- UNZIPPING {ACTUAL_ZIP_FILE} ---")

    # Use shlex.quote to handle spaces safely
    unzip_command = f'unzip -q "{ACTUAL_ZIP_FILE}" -d {UNZIPPED_DIR}'
    os.system(unzip_command)

    # 6. Verification
    print("\n✅ Unzip Complete. Checking contents (should see train/val/test folders or images):")
    !ls -F {UNZIPPED_DIR} | head -n 5

# 7. Check data.yaml file structure for YOLOv8
print("\n--- data.yaml verification (Check if paths match the unzipped structure) ---")
!cat {DATA_YAML_PATH}

# to ensure they point to the correct Colab location.
print("--- AUTOMATICALLY ADJUSTING DATA.YAML PATHS ---")

# Assuming Roboflow structure is: /content/unzipped_data/train/images
# We need to tell YOLO where the absolute paths are.
NEW_TRAIN_PATH = os.path.join(UNZIPPED_DIR, "train", "images")
NEW_VAL_PATH = os.path.join(UNZIPPED_DIR, "valid", "images")
NEW_TEST_PATH = os.path.join(UNZIPPED_DIR, "test", "images")

try:
    with open(DATA_YAML_PATH, 'r') as f:
        yaml_content = f.read()

    # Simple string replacements for common Roboflow export relative paths
    yaml_content = yaml_content.replace('train: ../train/images', f'train: {NEW_TRAIN_PATH}')
    yaml_content = yaml_content.replace('val: ../valid/images', f'val: {NEW_VAL_PATH}')
    yaml_content = yaml_content.replace('test: ../test/images', f'test: {NEW_TEST_PATH}')

    with open(DATA_YAML_PATH, 'w') as f:
        f.write(yaml_content)

    print(f"Paths updated successfully!")
    print("\n--- FINAL VERIFIED data.yaml ---")
    !cat {DATA_YAML_PATH}

except Exception as e:
    print(f"❌ ERROR adjusting YAML: {e}")
    print("Please manually ensure your data.yaml file points to the absolute paths within /content/unzipped_data/")

import os
import yaml
from ultralytics import YOLO

# --- Configuration ---
# Since the data was unzipped flat into /content/, the data.yaml is in the root.
DATASET_YAML_PATH = "data.yaml"
MODEL_NAME = 'yolov8s.pt'
EPOCHS = 50
BATCH_SIZE = 16

# --- 1. CORRECTING data.yaml CONTENTS (CRUCIAL STEP) ---
print("--- Step 1: Correcting data.yaml Content for Flat Structure ---")

# The original data.yaml used paths like '../train/images'.
# Since everything is now in the same folder as data.yaml, we must remove the '../'.
try:
    with open(DATASET_YAML_PATH, 'r') as f:
        data_yaml = yaml.safe_load(f)

    # Correct the paths to simple relative paths (e.g., 'train/images' instead of '../train/images')
    # This assumes the Roboflow structure has 'images' inside 'train', 'valid', and 'test'.
    data_yaml['train'] = data_yaml['train'].replace('../', '')
    data_yaml['val'] = data_yaml['val'].replace('../', '')
    data_yaml['test'] = data_yaml['test'].replace('../', '')

    # Write the corrected YAML back to the file
    with open(DATASET_YAML_PATH, 'w') as f:
        yaml.safe_dump(data_yaml, f)

    print(f"✅ Successfully updated paths inside '{DATASET_YAML_PATH}'.")

except FileNotFoundError:
    print(f"❌ CRITICAL ERROR: '{DATASET_YAML_PATH}' not found in the root directory. Please ensure it was uploaded and not in a subfolder.")
    # Stop execution if the YAML file is not found
    raise
except Exception as e:
    print(f"❌ Failed to parse or rewrite data.yaml: {e}")
    # Stop execution if we can't fix the YAML
    raise


# --- 2. LOAD MODEL ---
print("\n--- Step 2: Loading Pretrained YOLOv8s Model ---")
try:
    # Load the specified pretrained model
    model = YOLO(MODEL_NAME)
    print(f"✅ {MODEL_NAME} loaded successfully.")
except Exception as e:
    print(f"❌ Error loading model: {e}")
    raise # Re-raise if model loading fails


# --- 3. START TRAINING ---
print("\n--- Step 3: Starting YOLOv8 Training ---")
print(f"Training on data located at: /content/{DATASET_YAML_PATH}")

try:
    # Define the training configuration
    results = model.train(
        data=DATASET_YAML_PATH,     # Now correctly pointing to 'data.yaml' in the root
        imgsz=640,                  # Resize images to 640x640 for training
        epochs=EPOCHS,              # Number of training cycles
        batch=BATCH_SIZE,           # Number of images per batch
        name='v8s_custom_model',    # Name of the specific run (for organization)
        project='garbha_ai_training', # Name of the overall project folder
        patience=20,                # Stop training early
        device=0,                   # Use the first GPU
        seed=0,                     # Set seed for reproducibility
    )

    print("\n\n--- Training COMPLETE! ---")
    print("Next steps: Review the plots, evaluate the model (using model.val()), and run inference (model.predict()).")

except Exception as e:
    print(f"\n❌ A serious error occurred during training. Check the stack trace above for details.")
    print("The training process failed, but the data path should now be fixed.")
    print("The remaining issue is likely a mismatch in the image/label count or file paths within the train/valid folders.")

import os
from ultralytics import YOLO

# --- Configuration ---
# The path where the best performing weights were saved.
# Adjust the 'v8s_custom_model6' if you ran the training multiple times
# and a different folder was created. Check the output of the previous run!
BEST_MODEL_PATH = '/content/garbha_ai_training/v8s_custom_model6/weights/best.pt'
TEST_DATA_PATH = 'test/images'
PREDICTION_OUTPUT_FOLDER = 'garbha_ai_predictions'

# --- 1. LOAD THE TRAINED MODEL ---
print("--- Step 1: Loading the Best Trained Model ---")
try:
    # Load the best weights from your previous training run
    model = YOLO(BEST_MODEL_PATH)
    print(f"✅ Successfully loaded model from: {BEST_MODEL_PATH}")
except Exception as e:
    print(f"❌ Error loading model. Check the path: {BEST_MODEL_PATH}")
    print(f"Error details: {e}")
    # Stop if we can't load the model
    exit()


# --- 2. RUN PREDICTION ---
print("\n--- Step 2: Running Inference on Test Images ---")
print(f"Source images: {TEST_DATA_PATH}")

try:
    # Run prediction (inference) on all images in the specified folder
    results = model.predict(
        source=TEST_DATA_PATH,  # Path to the folder containing test images
        save=True,              # Save the predicted images
        save_conf=True,         # Save the confidence scores on the images
        conf=0.25,              # Only show predictions with confidence > 25%
        name=PREDICTION_OUTPUT_FOLDER, # Name the results folder
        project='garbha_ai_testing' # Name of the project root
    )

    print("\n\n--- Prediction COMPLETE! ---")

    # The results are saved in a subfolder inside 'garbha_ai_testing'
    output_directory = f"/content/garbha_ai_testing/{PREDICTION_OUTPUT_FOLDER}"
    print(f"The predicted images (with bounding boxes) are saved in: {output_directory}")
    print("\nNext steps: Download and review these images to manually assess the model's accuracy.")

except Exception as e:
    print(f"\n❌ A serious error occurred during prediction.")
    print(f"Ensure the test folder '{TEST_DATA_PATH}' exists and contains images.")
    print(f"Error details: {e}")

import os
from ultralytics import YOLO

# --- Configuration ---
# Path to the best trained model weights from your previous run (v8s_custom_model6)
BEST_MODEL_PATH = '/content/garbha_ai_training/v8s_custom_model6/weights/best.pt'

# Path to the data configuration file (where the paths to train/valid/test images are defined)
DATASET_YAML_PATH = "data.yaml"
VAL_OUTPUT_FOLDER = 'final_evaluation'

# --- 1. LOAD THE TRAINED MODEL ---
print("--- Step 1: Loading the Best Trained Model ---")
try:
    # Load the best weights
    model = YOLO(BEST_MODEL_PATH)
    print(f"✅ Successfully loaded model from: {BEST_MODEL_PATH}")
except Exception as e:
    print(f"❌ Error loading model. Check the path: {BEST_MODEL_PATH}")
    print(f"Error details: {e}")
    # Stop if we can't load the model
    exit()

# --- 2. RUN VALIDATION (EVALUATION) ---
print("\n--- Step 2: Running Final Validation (Evaluation) ---")
print("This generates performance metrics, including the confusion matrix and plots.")

try:
    # Run validation on the test set using the best model
    # By default, YOLO uses the 'val' set defined in data.yaml for this step.
    results = model.val(
        data=DATASET_YAML_PATH,         # Use the fixed data.yaml path
        imgsz=640,
        split="val",                    # Explicitly validate on the validation set
        save_json=True,                 # Save metrics in JSON format
        name=VAL_OUTPUT_FOLDER,         # Name the results folder
        project='garbha_ai_testing',    # Overall project folder
        device=0
    )

    print("\n\n--- Evaluation COMPLETE! ---")
    print(f"Final results (metrics, plots, confusion matrix) saved to: /content/garbha_ai_testing/{VAL_OUTPUT_FOLDER}")
    print("\nReview the saved plots (P_curve, R_curve, F1_curve, confusion_matrix) for detailed analysis.")

    # You can access specific metrics here if needed, but the saved plots are the best visual aid
    print("\n--- Summary Metrics ---")
    print(f"mAP50: {results.box.map50:.3f}")
    print(f"mAP50-95: {results.box.map:.3f}")


except Exception as e:
    print(f"\n❌ A serious error occurred during validation.")
    print(f"Ensure the required data directories are still present (train/ and valid/).")
    print(f"Error details: {e}")